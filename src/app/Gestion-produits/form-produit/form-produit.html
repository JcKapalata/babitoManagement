<form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="main">
  
  <div class="card">
    <div class="card-header">
      <i class="icon-info"></i> <h3>Informations Générales</h3>
    </div>
    <div class="form-grid">
      <div class="field">
        <label>Code Fournisseur</label>
        <input formControlName="codeFournisseur" placeholder="ex: BBI" [class.is-invalid]="productForm.get('codeFournisseur')?.invalid && productForm.get('codeFournisseur')?.touched">
        @if (productForm.get('codeFournisseur')?.touched && productForm.get('codeFournisseur')?.errors?.['required']) {
          <span class="err-msg">Code fournisseur obligatoire</span>
        }
      </div>

      <div class="field">
        <label>Code Produit</label>
        <input formControlName="codeProduit" placeholder="ex: BBI-VET-001">
        @if (productForm.get('codeProduit')?.touched && productForm.get('codeProduit')?.errors?.['required']) {
          <span class="err-msg">Code produit obligatoire</span>
        }
      </div>

      <div class="field">
        <label>Nom du produit</label>
        <input formControlName="nom" placeholder="ex: Body bébé coton">
        @if (productForm.get('nom')?.touched) {
          @if (productForm.get('nom')?.errors?.['required']) { <span class="err-msg">Le nom est requis</span> }
          @if (productForm.get('nom')?.errors?.['minlength']) { <span class="err-msg">3 caractères minimum</span> }
        }
      </div>

      <div class="field">
        <label>Région</label>
        <input formControlName="region">
      </div>

      <div class="field" style="grid-column: 1 / -1;">
        <label>Description du produit</label>
        <textarea formControlName="description" rows="3" placeholder="Décrivez le produit..."></textarea>
        @if (productForm.get('description')?.touched) {
          @if (productForm.get('description')?.errors?.['required']) { <span class="err-msg">Description requise</span> }
          @if (productForm.get('description')?.errors?.['maxlength']) { <span class="err-msg">Maximum 500 caractères</span> }
        }
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <i class="icon-tag"></i> <h3>Classification</h3>
    </div>
    <div class="form-grid">
      <div class="field">
        <label>Classement</label>
        <input formControlName="classement">
      </div>
      <div class="field">
        <label>Catégorie</label>
        <input formControlName="categorie">
      </div>
      <div class="field">
        <label>Type</label>
        <input formControlName="type">
      </div>
      <div class="field">
        <label>Devise</label>
        <select formControlName="devise">
          <option value="USD">USD ($)</option>
          <option value="CDF">CDF (FC)</option>
        </select>
      </div>
    </div>
  </div>

  <div formArrayName="taillesArray" class="variants-container">
    <div class="flex-between">
      <h3>Variantes par Taille</h3>
      <button type="button" class="btn-add" (click)="ajouterTaille()">+ Ajouter une taille</button>
    </div>

    @if (taillesArray.touched && taillesArray.invalid) {
      <div class="alert-box">Veuillez ajouter au moins une taille valide (nom et prix).</div>
    }

    @for (t of taillesArray.controls; track $index; let i = $index) {
      <div [formGroupName]="i" class="taille-card">
        <div class="taille-main-info">
          <div class="field" style="flex:2">
            <input formControlName="nomTaille" placeholder="Taille (ex: XL)">
            @if (t.get('nomTaille')?.touched && t.get('nomTaille')?.invalid) { <span class="err-msg">Nom requis</span> }
          </div>
          <div class="field" style="flex:1">
            <input type="number" formControlName="prix" placeholder="Prix">
            @if (t.get('prix')?.touched && t.get('prix')?.invalid) { <span class="err-msg">Prix > 0 requis</span> }
          </div>
          <button type="button" class="btn-remove" (click)="taillesArray.removeAt(i)">Supprimer Taille</button>
        </div>

        <div formArrayName="couleurs" class="couleurs-grid">
          @for (c of getCouleurs(i).controls; track $index; let j = $index) {
            <div [formGroupName]="j" class="couleur-card">
              <div class="image-picker">
                <div class="preview" [style.backgroundImage]="c.get('image')?.value ? 'url(' + c.get('image')?.value + ')' : ''" [class.placeholder]="!c.get('image')?.value">
                  @if (!c.get('image')?.value) { Photo }
                </div>
                <label [for]="'file-' + i + '-' + j" class="btn-file">Choisir</label>
                <input type="file" [id]="'file-' + i + '-' + j" (change)="onFileSelected($event, i, j)" hidden accept="image/*">
                @if (c.get('image')?.touched && c.get('image')?.invalid) { <span class="err-msg">Image requise</span> }
              </div>

              <div class="couleur-fields">
                <input formControlName="nom" placeholder="Couleur">
                @if (c.get('nom')?.touched && c.get('nom')?.invalid) { <span class="err-msg">Requis</span> }
                
                <input type="number" formControlName="stock" placeholder="Stock">
                @if (c.get('stock')?.touched && c.get('stock')?.invalid) {
                  @if (c.get('stock')?.errors?.['pattern']) { <span class="err-msg">Nombre entier uniquement</span> }
                  @else { <span class="err-msg">Stock invalide</span> }
                }
                <button type="button" (click)="getCouleurs(i).removeAt(j)" class="btn-text-del">Supprimer couleur</button>
              </div>
            </div>
          }
          <button type="button" class="btn-add-couleur" (click)="ajouterCouleur(i)">+ Ajouter une couleur</button>
        </div>
      </div>
    }
  </div>

  <div class="actions">
    <button type="submit" class="btn-submit" [disabled]="productForm.invalid && productForm.touched">Enregistrer le Produit</button>
  </div>
</form>