<div class="card-control">
  <div class="card-header">
    <i class="fas fa-users-cog"></i>
    <h3>Assignation Logistique</h3>
  </div>

  <form [formGroup]="controlForm" (ngSubmit)="confirmAssignment()" class="card-body">
    
    <div class="field">
      <label class="field-label">Agents responsables ({{ getSelectedAgentsCount() }})</label>
      
      <div class="agents-grid">
        @for (agent of agents; track agent.id) {
          <div class="agent-chip" 
               [class.active]="isAgentSelected(agent.id)"
               (click)="onAgentToggle(agent.id)">
            
            <div class="avatar-container">
              <img [src]="agent.avatar || '/profileAvatar/default-avatar.jpeg'" 
                   [alt]="agent.firstName" 
                   class="agent-img">
            </div>

            <div class="chip-content">
              <span class="name">{{ agent.firstName }} {{ agent.lastName[0] }}.</span>
              <span class="role">{{ agent.role }}</span>
            </div>

            @if (isAgentSelected(agent.id)) {
              <div class="selection-badge">
                <i class="fas fa-check"></i>
              </div>
            }
          </div>
        } @empty {
          <div class="empty-state">Aucun agent disponible</div>
        }
      </div>
    </div>

    <div class="field">
      <label class="field-label">Notes internes</label>
      <textarea formControlName="internalNotes" placeholder="Instructions pour les agents..."></textarea>
    </div>

    <div class="card-footer">
      <button type="submit" class="btn-primary" [disabled]="getSelectedAgentsCount() === 0 || loading">
        @if (loading) {
          <i class="fas fa-spinner fa-spin"></i>
        } @else {
          Assigner {{ getSelectedAgentsCount() }} agent(s)
        }
      </button>
    </div>
  </form>
</div>