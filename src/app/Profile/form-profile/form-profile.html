<form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="profile-container">
  
  <div class="avatar-section">
    <div class="image-wrapper" (click)="fileInput.click()">
      <img [src]="imagePreview || 'profileAvatar/default-avatar.jpeg'" alt="Avatar">
      <div class="overlay"><mat-icon>camera_alt</mat-icon></div>
    </div>
    <input type="file" #fileInput (change)="onFileSelected($event)" hidden accept="image/*">
  </div>

  <div class="form-grid">
    <mat-form-field appearance="outline">
      <mat-label>Prénom</mat-label>
      <input matInput formControlName="firstName">
      @if (profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched) {
        <mat-error>{{ getErrorMessage('firstName') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Nom</mat-label>
      <input matInput formControlName="lastName">
      @if (profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched) {
        <mat-error>{{ getErrorMessage('lastName') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Email</mat-label>
      <input matInput type="email" formControlName="email">
      @if (profileForm.get('email')?.invalid && profileForm.get('email')?.touched) {
        <mat-error>{{ getErrorMessage('email') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Rôle</mat-label>
      <mat-select formControlName="role">
        @for (role of roles; track role) {
          <mat-option [value]="role">{{ role | titlecase }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    @if (isUpdateMode) {
      <div class="full-width password-toggle-row">
        <mat-divider></mat-divider>
        <button type="button" class="btn-secondary" mat-button color="accent" (click)="togglePasswordFields()">
          <mat-icon>{{ showPasswordFields ? 'expand_less' : 'lock_reset' }}</mat-icon>
          {{ showPasswordFields ? 'Annuler la modification du mot de passe' : 'Modifier le mot de passe' }}
        </button>
      </div>
    }

    @if (showPasswordFields) {
      <div class="password-group full-width">
        <mat-form-field appearance="outline">
          <mat-label>Mot de passe</mat-label>
          <input matInput [type]="hidePasswordContent ? 'password' : 'text'" formControlName="password">
          <button type="button" mat-icon-button matSuffix (click)="hidePasswordContent = !hidePasswordContent">
            <mat-icon>{{ hidePasswordContent ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          @if (profileForm.get('password')?.invalid) {
            <mat-error>{{ getErrorMessage('password') }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Confirmation</mat-label>
          <input matInput [type]="hidePasswordContent ? 'password' : 'text'" formControlName="confirmPassword">
          @if (profileForm.get('confirmPassword')?.hasError('passwordMismatch')) {
            <mat-error>{{ getErrorMessage('confirmPassword') }}</mat-error>
          }
        </mat-form-field>
      </div>
    }
  </div>

  <div class="actions">
    <button mat-button type="button" class="btn-secondary" (click)="cancel()">Annuler</button>
    <button mat-flat-button class="btn-submit" color="primary" type="submit" [disabled]="profileForm.invalid">
      <mat-icon>save</mat-icon>
      {{ isUpdateMode ? 'Enregistrer les modifications' : 'Créer le profil' }}
    </button>
  </div>
</form>